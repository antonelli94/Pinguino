<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Manager</title>
    <style>
        body { background-color: #0f1923; color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; text-align: center; }
        .hidden { display: none !important; }
        
        /* LOGIN */
        #login-screen { padding-top: 50px; }
        input { padding: 15px; width: 80%; margin: 10px 0; border-radius: 5px; border: none; font-size: 18px; }
        .btn-start { background: #ff4655; color: white; border: none; padding: 15px 40px; font-size: 20px; font-weight: bold; border-radius: 5px; cursor: pointer; }

        /* TAVOLO GIOCO */
        .top-bar { display: flex; justify-content: space-between; padding: 15px; background: #1f2731; border-bottom: 2px solid #ff4655; }
        .my-chips { color: #ffeb3b; font-weight: bold; font-size: 1.2em; }
        
        .pot-display { margin: 20px auto; width: 150px; height: 150px; background: #2c3e50; border-radius: 50%; border: 5px solid #27ae60; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(39, 174, 96, 0.4); }
        .pot-label { font-size: 14px; color: #aaa; }
        .pot-amount { font-size: 32px; font-weight: bold; color: #fff; }

        /* GIOCATORI */
        #players-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; }
        .player-card { background: #333; padding: 10px; border-radius: 8px; min-width: 100px; position: relative; border: 2px solid transparent; }
        .player-card.active-turn { border-color: #ff4655; background: #444; box-shadow: 0 0 10px #ff4655; }
        .player-card.folded { opacity: 0.4; text-decoration: line-through; }
        .player-chips { color: #ffeb3b; font-size: 0.9em; }
        .player-bet { color: #27ae60; font-size: 0.8em; }

        /* CONTROLLI AZIONE (Barra in basso) */
        #action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; padding: 15px; display: flex; justify-content: center; gap: 10px; border-top: 1px solid #333; }
        .btn-game { padding: 15px 20px; font-size: 16px; border: none; border-radius: 5px; font-weight: bold; flex: 1; color: #000; }
        .btn-fold { background: #e74c3c; color: white; }
        .btn-check { background: #3498db; color: white; }
        .btn-call { background: #f1c40f; }
        .btn-raise { background: #2ecc71; }

        /* ADMIN PANEL */
        #admin-controls { background: #4a0000; padding: 10px; margin-bottom: 10px; }
        .admin-btn { background: #ff4655; color: white; border: none; padding: 8px; margin: 2px; border-radius: 4px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <h1>♠️ POKER MANAGER</h1>
        <input type="text" id="username" placeholder="Tuo Nome (es. Ciccio)">
        <input type="text" id="roomCode" placeholder="Nome Stanza" value="tavolo1">
        <br><br>
        <button class="btn-start" onclick="enterGame()">ENTRA AL TAVOLO</button>
    </div>

    <!-- TAVOLO -->
    <div id="game-screen" class="hidden">
        
        <!-- Info Personali -->
        <div class="top-bar">
            <span id="my-name">Io</span>
            <span class="my-chips">€ <span id="my-balance">0</span></span>
        </div>

        <!-- Pannello Admin (Solo per Ciccio/Creator) -->
        <div id="admin-controls" class="hidden">
            <p style="margin:0; font-size:12px; color:#aaa">COMANDI BANCHIERE</p>
            <button class="admin-btn" onclick="startRound()">Nuova Mano (Ante 1€)</button>
            <p style="font-size:10px;">Clicca su un giocatore per assegnare vittoria o ricaricare</p>
        </div>

        <!-- PIATTO CENTRALE -->
        <div class="pot-display">
            <span class="pot-label">PIATTO</span>
            <span class="pot-amount">€ <span id="pot-amount">0</span></span>
            <span style="font-size:12px; color:#aaa; margin-top:5px">Puntata Max: <span id="current-bet">0</span></span>
        </div>

        <div style="margin-bottom:10px; font-size:14px; color:#ff4655; font-weight:bold" id="turn-indicator">In attesa...</div>

        <!-- ALTRI GIOCATORI -->
        <div id="players-grid"></div>

        <!-- SPAZIO VUOTO PER NON COPRIRE CON LA BARRA -->
        <div style="height: 80px;"></div>

        <!-- BOTTONI AZIONE (Visibili solo se è il tuo turno) -->
        <div id="action-bar" class="hidden">
            <button class="btn-game btn-fold" onclick="doAction('FOLD')">FOLD</button>
            <button class="btn-game btn-check" id="btn-check-call" onclick="checkOrCall()">CHECK</button>
            <button class="btn-game btn-raise" onclick="doRaise()">RILANCIA</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myId = null;
        let myRoom = null;
        let iamAdmin = false;
        let currentMaxBet = 0;
        let myBetInRound = 0;

        function enterGame() {
            const user = document.getElementById('username').value;
            const code = document.getElementById('roomCode').value;
            if(!user) return alert("Metti il nome!");
            
            myRoom = code;
            socket.emit('joinRoom', { username: user, roomCode: code });
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('my-name').innerText = user;
        }

        socket.on('connect', () => { myId = socket.id; });

        socket.on('updateGame', (room) => {
            currentMaxBet = room.currentBet;
            
            const me = room.players.find(p => p.id === myId);
            if(me) {
                document.getElementById('my-balance').innerText = me.chips;
                myBetInRound = me.betInRound;
                iamAdmin = me.isAdmin;
                if(iamAdmin) document.getElementById('admin-controls').classList.remove('hidden');
            }

            // Aggiorna Piatto
            document.getElementById('pot-amount').innerText = room.pot;
            document.getElementById('current-bet').innerText = room.currentBet;

            // Aggiorna Giocatori
            const grid = document.getElementById('players-grid');
            grid.innerHTML = '';
            
            // Gestione Turno
            const activePlayer = room.players[room.turnIndex];
            const isMyTurn = (activePlayer && activePlayer.id === myId && room.phase === 'BETTING');
            
            if(activePlayer) {
                document.getElementById('turn-indicator').innerText = 
                    isMyTurn ? "TOCCA A TE! Scegli azione:" : `Tocca a ${activePlayer.username}...`;
            }

            room.players.forEach(p => {
                const div = document.createElement('div');
                div.className = `player-card ${p.id === activePlayer?.id ? 'active-turn' : ''} ${p.folded ? 'folded' : ''}`;
                div.innerHTML = `
                    <div style="font-weight:bold">${p.username}</div>
                    <div class="player-chips">€ ${p.chips}</div>
                    <div class="player-bet">Puntato: ${p.betInRound}</div>
                `;
                
                // Admin Actions (Assegna vittoria / Ricarica)
                if(iamAdmin) {
                    div.onclick = () => adminMenu(p);
                    div.style.cursor = "pointer";
                }
                grid.appendChild(div);
            });

            // Gestione Pulsantiera
            const actionBar = document.getElementById('action-bar');
            const btnCheckCall = document.getElementById('btn-check-call');

            if(isMyTurn) {
                actionBar.classList.remove('hidden');
                
                // Logica Check vs Call
                const diff = currentMaxBet - myBetInRound;
                if(diff > 0) {
                    btnCheckCall.innerText = `VEDO (${diff})`;
                    btnCheckCall.className = 'btn-game btn-call';
                    btnCheckCall.onclick = () => doAction('CALL');
                } else {
                    btnCheckCall.innerText = 'CHECK';
                    btnCheckCall.className = 'btn-game btn-check';
                    btnCheckCall.onclick = () => doAction('CHECK');
                }
            } else {
                actionBar.classList.add('hidden');
            }
        });

        // ACTIONS UTENTE
        function doAction(type) {
            socket.emit('playerAction', { roomCode: myRoom, action: type });
        }
        
        function checkOrCall() { /* Gestito dinamicamente sopra */ }

        function doRaise() {
            const raiseTo = prompt(`Il banco è ${currentMaxBet}. A quanto vuoi portare la puntata totale? (Es. 5)`);
            if(raiseTo && parseInt(raiseTo) > currentMaxBet) {
                socket.emit('playerAction', { roomCode: myRoom, action: 'RAISE', amount: raiseTo });
            } else {
                alert("Devi rilanciare una cifra superiore all'attuale!");
            }
        }

        // ACTIONS ADMIN
        function startRound() {
            const ante = prompt("Costo invito (Ante) per questa mano? (Es. 1)", "1");
            if(ante) socket.emit('startRound', { roomCode: myRoom, anteAmount: parseInt(ante) });
        }

        function adminMenu(player) {
            if(!confirm(`Gestione ${player.username}.\nOK = Assegna Vittoria (Incassa Piatto)\nANNULLA = Ricarica Conto`)) {
                // Ricarica
                const amount = prompt("Quanto vuoi ricaricare?");
                if(amount) socket.emit('addChips', { roomCode: myRoom, targetId: player.id, amount: amount });
            } else {
                // Vittoria
                socket.emit('winner', { roomCode: myRoom, winnerId: player.id });
            }
        }
    </script>
</body>
</html>
